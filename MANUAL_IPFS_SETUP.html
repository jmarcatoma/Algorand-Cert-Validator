<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìò Manual IPFS Cluster - Configuraci√≥n Completa</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        header h1 { font-size: 2.5em; margin-bottom: 10px; }
        header p { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 40px; }
        h2 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            font-size: 1.8em;
        }
        h3 {
            color: #764ba2;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
        }
        h4 {
            color: #555;
            margin: 20px 0 10px 0;
            font-size: 1.1em;
        }
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f5f5f5; }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #e83e8c;
        }
        pre code { background: none; color: #d4d4d4; padding: 0; }
        .step {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid #dee2e6;
        }
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
        ul, ol { margin: 15px 0; padding-left: 30px; }
        li { margin: 8px 0; }
        .checklist { list-style: none; padding-left: 0; }
        .checklist li:before { content: "‚òê "; color: #667eea; font-size: 1.2em; margin-right: 8px; }
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .toc ul { list-style: none; }
        .toc a {
            color: #667eea;
            text-decoration: none;
            display: block;
            padding: 5px 0;
        }
        .toc a:hover { text-decoration: underline; }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-primary { background: #667eea; color: white; }
        .badge-secondary { background: #764ba2; color: white; }
        .badge-success { background: #28a745; color: white; }
        footer {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            color: #666;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìò Manual Completo</h1>
            <p>Configuraci√≥n IPFS Cluster con Sincronizaci√≥n Autom√°tica</p>
        </header>

        <div class="content">
            <div class="info-box">
                <h3>üéØ Objetivo</h3>
                <p>Configurar un cluster IPFS de 3 nodos con sincronizaci√≥n autom√°tica del √≠ndice de certificados usando IPNS y systemd.</p>
            </div>

            <h2>üìã Informaci√≥n de Nodos (EJEMPLO)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nodo</th>
                        <th>IP</th>
                        <th>Usuario</th>
                        <th>Rol</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>194</td>
                        <td>192.168.1.194</td>
                        <td><code>jmarcatoma</code></td>
                        <td><span class="badge badge-primary">Principal</span></td>
                    </tr>
                    <tr>
                        <td>193</td>
                        <td>192.168.1.193</td>
                        <td><code>nodo1</code></td>
                        <td><span class="badge badge-secondary">Secundario</span></td>
                    </tr>
                    <tr>
                        <td>192</td>
                        <td>192.168.1.192</td>
                        <td><code>nodo3</code></td>
                        <td><span class="badge badge-secondary">Terciario</span></td>
                    </tr>
                </tbody>
            </table>

            <div class="step">
                <h2><span class="step-number">1</span> Exportar IPNS Key del Nodo Principal</h2>
                <h4>En Nodo 194 (Principal)</h4>
                <pre><code>ssh jmarcatoma@192.168.1.194

# 1. Verificar que la key existe
ipfs key list -l

# Deber√≠as ver:
# k51qzi5uqu5dhonp113olftb52kmnb3vo9nvyc20910k7nk1pgurprtwp3b0sb algocert-index-key

# 2. Exportar la key
ipfs key export algocert-index-key

# 3. Verificar el archivo
ls -lh algocert-index-key.key

# 4. Ver el ID de la key (anotarlo)
ipfs key list -l | grep algocert-index-key</code></pre>
                <div class="info-box">
                    <strong>üìù Anotar el ID:</strong> <code>k51qzi5uqu5dhonp113olftb52kmnb3vo9nvyc20910k7nk1pgurprtwp3b0sb</code>
                </div>
            </div>

            <div class="step">
                <h2><span class="step-number">2</span> Copiar Key a Otros Nodos</h2>
                <h4>Desde Nodo 194</h4>
                <pre><code># Copiar a nodo 193
scp algocert-index-key.key nodo1@192.168.1.193:~/

# Copiar a nodo 192
scp algocert-index-key.key nodo3@192.168.1.192:~/</code></pre>
            </div>

            <div class="step">
                <h2><span class="step-number">3</span> Importar Key en Nodo 193</h2>
                <pre><code>ssh nodo1@192.168.1.193

# 1. Verificar que el archivo lleg√≥
ls -lh ~/algocert-index-key.key

# 2. Importar la key
ipfs key import algocert-index-key algocert-index-key.key

# 3. Verificar importaci√≥n
ipfs key list -l | grep algocert-index-key

# 4. Eliminar archivo de key (seguridad)
rm ~/algocert-index-key.key</code></pre>
                <div class="success-box">
                    ‚úÖ Debe mostrar el <strong>MISMO ID</strong> que nodo 194
                </div>
            </div>

            <div class="step">
                <h2><span class="step-number">4</span> Importar Key en Nodo 192</h2>
                <pre><code>ssh nodo3@192.168.1.192

# Repetir los mismos pasos del Paso 3
ipfs key import algocert-index-key algocert-index-key.key
ipfs key list -l | grep algocert-index-key
rm ~/algocert-index-key.key</code></pre>
            </div>

            <div class="step">
                <h2><span class="step-number">5</span> Verificar IPNS en Todos los Nodos</h2>
                <pre><code># EN CADA NODO (194, 193, 192), ejecutar:

# 1. Obtener ID de la key
ipfs key list -l | grep algocert-index-key

# 2. Intentar resolver IPNS
ipfs name resolve /ipns/k51qzi5uqu5dhonp113olftb52kmnb3vo9nvyc20910k7nk1pgurprtwp3b0sb</code></pre>
                <div class="info-box">
                    <strong>Nota:</strong> Si sale "Error: could not resolve name" es normal si nunca se ha publicado. Continuamos.
                </div>
            </div>

            <div class="step">
                <h2><span class="step-number">6</span> Crear Script de Sincronizaci√≥n</h2>
                <h4>En CADA Nodo (194, 193, 192)</h4>
                <pre><code>sudo nano /usr/local/bin/ipfs-sync-index.sh</code></pre>
                <p><strong>Pegar este contenido:</strong></p>
                <pre><code>#!/bin/bash
IPNS_KEY="k51qzi5uqu5dhonp113olftb52kmnb3vo9nvyc20910k7nk1pgurprtwp3b0sb"
LOG_FILE="/var/log/ipfs-index-sync.log"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }

log "=========================================="
log "üîÑ Iniciando sincronizaci√≥n de √≠ndice IPFS"

# Esperar a que IPFS est√© listo
log "‚è≥ Esperando a que IPFS est√© listo..."
for i in {1..10}; do
    if ipfs id > /dev/null 2>&1; then
        log "‚úÖ IPFS listo (intento $i/10)"
        break
    fi
    if [ $i -eq 10 ]; then
        log "‚ùå IPFS no respondi√≥, abortando"
        exit 1
    fi
    sleep 3
done

sleep 5

# Resolver IPNS
log "üîç Resolviendo IPNS: /ipns/$IPNS_KEY"
IPNS_CID=""
for i in {1..3}; do
    IPNS_CID=$(ipfs name resolve /ipns/$IPNS_KEY 2>&1 | grep -oP '/ipfs/\K\w+')
    if [ -n "$IPNS_CID" ]; then
        log "‚úÖ IPNS resuelto: $IPNS_CID"
        break
    fi
    [ $i -lt 3 ] && log "‚è≥ Reintentando... ($i/3)" && sleep 2
done

if [ -z "$IPNS_CID" ]; then
    log "‚ö†Ô∏è  No se pudo resolver IPNS - manteniendo √≠ndice local"
    log "=========================================="
    exit 0
fi

# Comparar CID local con IPNS
LOCAL_CID=$(ipfs files stat /cert-index --hash 2>/dev/null | head -n1)

if [ "$LOCAL_CID" == "$IPNS_CID" ]; then
    log "‚úÖ √çndice ya sincronizado (CID: $LOCAL_CID)"
    log "=========================================="
    exit 0
fi

# Sincronizar √≠ndice
log "üîÑ Sincronizando √≠ndice:"
log "   Local: ${LOCAL_CID:-vac√≠o}"
log "   IPNS:  $IPNS_CID"

# Backup y copiar
BACKUP_PATH=""
if ipfs files stat /cert-index > /dev/null 2>&1; then
    BACKUP_PATH="/cert-index-backup-$(date +%s)"
    ipfs files cp /cert-index $BACKUP_PATH 2>/dev/null && log "üì¶ Backup: $BACKUP_PATH"
fi

ipfs files rm -r /cert-index 2>/dev/null
ipfs files cp /ipfs/$IPNS_CID /cert-index && log "‚úÖ √çndice copiado desde IPNS"

log "=========================================="
log "‚úÖ Sincronizaci√≥n completada"
log "=========================================="</code></pre>
                <pre><code># Dar permisos de ejecuci√≥n
sudo chmod +x /usr/local/bin/ipfs-sync-index.sh

# Crear archivo de log
sudo touch /var/log/ipfs-index-sync.log
sudo chown $(whoami):$(whoami) /var/log/ipfs-index-sync.log</code></pre>
            </div>

            <div class="step">
                <h2><span class="step-number">7</span> Crear Servicio IPFS</h2>
                <h4>Nodo 194</h4>
                <pre><code>sudo nano /etc/systemd/system/ipfs.service</code></pre>
                <pre><code>[Unit]
Description=IPFS Daemon
After=network.target

[Service]
Type=simple
User=jmarcatoma
Group=jmarcatoma
Environment="IPFS_PATH=/home/jmarcatoma/.ipfs"
ExecStart=/usr/local/bin/ipfs daemon
ExecStartPost=/bin/sleep 10
ExecStartPost=/usr/local/bin/ipfs-sync-index.sh
Restart=on-failure
RestartSec=10s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target</code></pre>
                
                <h4>Nodo 193</h4>
                <div class="warning-box">
                    ‚ö†Ô∏è Cambiar <code>User=nodo1</code>, <code>Group=nodo1</code>, <code>IPFS_PATH=/home/nodo1/.ipfs</code>
                </div>

                <h4>Nodo 192</h4>
                <div class="warning-box">
                    ‚ö†Ô∏è Cambiar <code>User=nodo3</code>, <code>Group=nodo3</code>, <code>IPFS_PATH=/home/nodo3/.ipfs</code>
                </div>
            </div>

            <div class="step">
                <h2><span class="step-number">8</span> Crear Servicio IPFS Cluster</h2>
                <pre><code>sudo nano /etc/systemd/system/ipfs-cluster.service</code></pre>
                <pre><code>[Unit]
Description=IPFS Cluster Service
After=ipfs.service
Requires=ipfs.service

[Service]
Type=simple
User=jmarcatoma
Group=jmarcatoma
ExecStart=/usr/local/bin/ipfs-cluster-service daemon
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target</code></pre>
                <div class="warning-box">
                    ‚ö†Ô∏è Ajustar <code>User</code> y <code>Group</code> seg√∫n nodo
                </div>
            </div>

            <div class="step">
                <h2><span class="step-number">9</span> Activar Servicios</h2>
                <h4>En CADA Nodo</h4>
                <pre><code># Detener procesos manuales
pkill ipfs-cluster-service
pkill ipfs
sleep 3

# Recargar systemd
sudo systemctl daemon-reload

# Habilitar auto-inicio
sudo systemctl enable ipfs.service
sudo systemctl enable ipfs-cluster.service

# Iniciar IPFS
sudo systemctl start ipfs.service
sleep 15

# Verificar
systemctl status ipfs.service

# Iniciar cluster
sudo systemctl start ipfs-cluster.service

# Verificar
systemctl status ipfs-cluster.service</code></pre>
            </div>

            <div class="step">
                <h2><span class="step-number">10</span> Crear Scripts de Usuario</h2>
                <h4>Script de Reinicio</h4>
                <pre><code>nano ~/restart-ipfs-sync.sh</code></pre>
                <pre><code>#!/bin/bash
echo "üîÑ Reiniciando IPFS..."
sudo systemctl stop ipfs-cluster.service
sudo systemctl stop ipfs.service
sleep 3
sudo systemctl start ipfs.service
sleep 10
sudo systemctl start ipfs-cluster.service
echo "‚úÖ Completado"</code></pre>
                <pre><code>chmod +x ~/restart-ipfs-sync.sh</code></pre>


            <h2>üìä Resumen de Archivos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Archivo</th>
                        <th>Ubicaci√≥n</th>
                        <th>Prop√≥sito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ipfs-sync-index.sh</code></td>
                        <td><code>/usr/local/bin/</code></td>
                        <td>Script de sincronizaci√≥n</td>
                    </tr>
                    <tr>
                        <td><code>ipfs.service</code></td>
                        <td><code>/etc/systemd/system/</code></td>
                        <td>Servicio IPFS</td>
                    </tr>
                    <tr>
                        <td><code>ipfs-cluster.service</code></td>
                        <td><code>/etc/systemd/system/</code></td>
                        <td>Servicio Cluster</td>
                    </tr>
                    <tr>
                        <td><code>restart-ipfs-sync.sh</code></td>
                        <td><code>~/</code></td>
                        <td>Reinicio manual</td>
                    </tr>
                    <tr>
                        <td><code>sync-now.sh</code></td>
                        <td><code>~/</code></td>
                        <td>Sync r√°pido</td>
                    </tr>
                </tbody>
            </table>

            <h2>‚úÖ Checklist de Verificaci√≥n</h2>
            <ul class="checklist">
                <li>IPNS key exportada del nodo 194</li>
                <li>Key importada en nodo 193</li>
                <li>Key importada en nodo 192</li>
                <li>Mismo key ID en los 3 nodos</li>
                <li>Script de sync creado en los 3 nodos</li>
                <li>Servicio ipfs.service creado en los 3 nodos</li>
                <li>Servicio ipfs-cluster.service creado en los 3 nodos</li>
                <li>Usuario correcto en cada servicio</li>
                <li>Servicios habilitados (auto-inicio)</li>
                <li>Servicios iniciados y funcionando</li>
                <li>Log de sync funciona</li>
                <li>Scripts de usuario creados</li>
                <li>Test de failover exitoso</li>
            </ul>

            <h2>üö® Troubleshooting</h2>
            
            <h3>Servicio no inicia</h3>
            <pre><code># Ver error detallado
sudo journalctl -u ipfs.service -n 50

# Verificar usuario
systemctl cat ipfs.service | grep User</code></pre>

            <h3>IPNS no resuelve</h3>
            <pre><code># Verificar key
ipfs key list -l | grep algocert-index-key

# Ver logs de sync
tail -f /var/log/ipfs-index-sync.log</code></pre>

            <h3>Sync falla</h3>
            <pre><code># Ver proceso ipfs
ps aux | grep "ipfs daemon"

# Ejecutar script manualmente
sudo /usr/local/bin/ipfs-sync-index.sh</code></pre>

            <div class="success-box">
                <h3>üéâ Sistema Completo y Funcional</h3>
                <ul>
                    <li>‚úÖ Auto-inicio al bootear</li>
                    <li>‚úÖ Sincronizaci√≥n autom√°tica</li>
                    <li>‚úÖ Scripts manuales disponibles</li>
                    <li>‚úÖ Backups autom√°ticos</li>
                    <li>‚úÖ Logs centralizados</li>
                </ul>
            </div>
        </div>

        <footer>
            <p>üìò Manual IPFS Cluster - Configuraci√≥n Completa</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Sistema de Validaci√≥n de Certificados Algorand</p>
        </footer>
    </div>
</body>
</html>
